# Meal Options routes

collection:
  get:
    tags: [Meal Options]
    summary: List all meal options
    description: |
      Returns the full catalogue of meal options (templates).
      Each option includes its associated meal time and ingredient list.
      Requires authentication.
    operationId: listMealOptions
    security:
      - bearerAuth: []
    responses:
      '200':
        description: List of meal options
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '../components/schemas/meal-options.yaml#/MealOption'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'

  post:
    tags: [Meal Options]
    summary: Create a meal option
    description: |
      Creates a new meal option template with associated ingredients.
      `meal_time_id` references a MealTime record (e.g. 1=Breakfast, 2=Lunch, 3=Snack, 4=Dinner).
    operationId: createMealOption
    security:
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/meal-options.yaml#/MealOptionCreateRequest'
          example:
            name: Oatmeal with banana
            description: High-fibre breakfast
            meal_time_id: 1
            estimated_calories: 320
            ingredients:
              - name: Rolled oats
                quantity: 80
                unit: g
              - name: Banana
                quantity: 1
                unit: unit
              - name: Almond milk
                quantity: 200
                unit: ml
    responses:
      '201':
        description: Meal option created
        content:
          application/json:
            schema:
              $ref: '../components/schemas/meal-options.yaml#/MealOption'
      '400':
        description: Missing required field or invalid ingredient data
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
      '404':
        description: MealTime not found
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'

item:
  put:
    tags: [Meal Options]
    summary: Update a meal option
    description: |
      Updates an existing meal option. All fields are optional.
      When `ingredients` is provided, it **replaces** the full ingredient list.
    operationId: updateMealOption
    security:
      - bearerAuth: []
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        example: 10
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/meal-options.yaml#/MealOptionUpdateRequest'
    responses:
      '200':
        description: Meal option updated
        content:
          application/json:
            schema:
              $ref: '../components/schemas/meal-options.yaml#/MealOption'
      '400':
        description: Invalid ingredient data
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
      '404':
        description: MealOption or MealTime not found
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'

  delete:
    tags: [Meal Options]
    summary: Delete a meal option
    description: Permanently deletes a meal option and its ingredients.
    operationId: deleteMealOption
    security:
      - bearerAuth: []
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        example: 10
    responses:
      '200':
        description: Meal option deleted
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/MessageResponse'
            example:
              message: MealOption deleted
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
      '404':
        description: MealOption not found
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'

import:
  post:
    tags: [File Import]
    summary: Import meal options from a nutritionist diet document
    description: |
      Upload a PDF, DOCX, or Markdown file containing a diet plan written by
      a nutritionist.

      The system will:
      1. Extract plain text from the document.
      2. Send it to **OpenAI** to identify every distinct meal option.
      3. Let OpenAI **estimate the calories** for each meal.
      4. Let OpenAI **infer the full ingredient list** with realistic quantities.
      5. Persist the resulting `MealOption` and `Ingredient` records and return them.

      **Supported formats:** PDF, DOCX, Markdown (`.md`), plain text
      **Maximum file size:** 5 MB
    operationId: importMealOptionsFromFile
    security:
      - bearerAuth: []
    requestBody:
      required: true
      content:
        multipart/form-data:
          schema:
            type: object
            required: [file]
            properties:
              file:
                type: string
                format: binary
                description: |
                  Nutritionist diet document. Accepted formats: .pdf, .docx, .md, .txt
                  Maximum size: 5 MB
    responses:
      '201':
        description: Meal options imported and created successfully
        content:
          application/json:
            schema:
              $ref: '../components/schemas/file-import.yaml#/FileImportResponse'
            example:
              imported: 3
              meal_options:
                - id: 42
                  name: "Oatmeal with banana and honey"
                  description: "Breakfast option recommended by nutritionist"
                  estimated_calories: 380
                  meal_time:
                    id: 1
                    name: breakfast
                    label: Breakfast
                  ingredients:
                    - id: 101
                      name: Rolled oats
                      quantity: 80
                      unit: g
      '400':
        description: |
          Invalid request. Possible causes:
          - No file uploaded
          - Unsupported file type
          - File contains no readable text
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
            example:
              error: "Unsupported file type. Allowed: PDF, DOCX, Markdown, plain text."
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
      '413':
        description: File exceeds the 5 MB size limit
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
            example:
              error: "File exceeds the maximum allowed size of 5 MB."
      '422':
        description: OpenAI could not extract valid meal data from the document
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
            example:
              error: "OpenAI could not extract meal options: Could not parse JSON from OpenAI response"
      '500':
        description: OpenAI API failure or unexpected server error
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/ErrorResponse'
